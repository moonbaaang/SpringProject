<%@page import="java.math.BigDecimal"%>
<%@page import="org.json.JSONArray"%>
<%@page import="org.json.JSONObject"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="jquery-3.2.1.min.js"></script>
<script>
$(document).ready(function(){

});
</script>
</head>
<body>
<h1> 얼굴 인식 서비스 </h1>

<% 
	String image = (String)request.getParameter("image");
	String faceResult2 = (String)request.getAttribute("faceResult2");
	
	JSONObject obj = new JSONObject(faceResult2);
	JSONArray faces = (JSONArray)obj.get("faces"); //
	
	for(Object one : faces){
		JSONObject roi = (JSONObject)((JSONObject)one).get("roi");
		int x = (int)roi.get("x");
		int y = (int)roi.get("y");
		int width = (int)roi.get("width");
		int height = (int)roi.get("height");
		out.println("얼굴 x좌표 = "+x+" y좌표 = "+y+" 가로크기 = "+width+" 세로크기 = "+height+"<br>" );
		
		//성별 나이 표정 포즈
%>
<script>
	var x = <%=x %>;
	var y = <%=y %>;
	var width = <%=width %>;
	var height = <%=height %>;
	
/*
	1. id="samplecanvas"에 image 변수 저장된 파일 그리기
	2. 1번 이미지에서 얼굴 x, y, width, height 값 가져오기
	3. 1번 이미지에서 2번 영역 얼굴만 복사하여 id=targetcanvas로 붙여넣기
*/
	window.onload = function(){
		var samplecanvas = document.getElementById("samplecanvas");
		var samplecontext = samplecanvas.getContext("2d");
		var sampleImage = new Image();
		sampleImage.src = "/faceimages/song.jpg";
		sampleImage.onload = function(){ //onload >> 바로 실행되는 것이 아닌 sampleImage가 onload되어야 실행됨, 따라서 아래 부분이 제대로 복사가 되지 않는다.
			samplecontext.drawImage(sampleImage, 0, 0, sampleImage.width, sampleImage.height); //이미지객체, x, y, w, h;

			var copyImage = samplecontext.getImageData(x, y, width, height); //그림을 잘라냄
		
			var targetcanvas = document.getElementById("targetcanvas");
			var targetcontext = targetcanvas.getContext("2d");
			targetcontext.putImageData(copyImage, x, y); // x,y 
		
		} //sample.onload end
		
		
}// window.onload end
</script>
<% 	
}
	for(int i = 0; i<faces.length(); i++){
		JSONObject face = (JSONObject)faces.get(i);
		JSONObject gender = (JSONObject)face.get("gender");
		String gendervalue = (String)gender.get("value");
		JSONObject age = (JSONObject)face.get("age");
		String agevalue = (String)age.get("value");
		JSONObject emotion = (JSONObject)face.get("emotion");
		String emotionvalue = (String)emotion.get("value");
		out.println("표정 = "+ emotionvalue + " 성별 = "+ gendervalue + " 나이 = "+agevalue +"<br>");
	}

%>



<h1>이미지 전체 캔버스</h1>
<canvas id="samplecanvas" width=500 height=500 style="border : solid 2px pink"></canvas>
<h1>얼굴만 캔버스</h1>
<canvas id="targetcanvas" width=300 height=300 style="border : solid 2px pink"></canvas>
</body>
</html>